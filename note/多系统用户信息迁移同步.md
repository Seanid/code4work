# 多系统用户信息迁移同步

## 需求说明
这是笔者第一个家公司的需求。公司存在A、B、C、D，四套系统，分别覆盖物流供应链，商城、ERP等多个业务。每个系统有独立的用户体系且互不相通。由于业务发展，所以需要将多个系统的用户信息合并，实现集团多个系统单点登录。

![](http://image.e65535.com/github/20240604194521.png)
## 问题分析
1. 多个系统各自存在自己的用户数据，且不全相同。部分信息完全不同，如敏感信息的加密解密方式、密码等不可逆信息等，没法通过单纯的数据迁移来达到业务整合。
2. 部分用户，在四个系统中都注册过，且购买过服务，此类用户，需要对多条数据进行合并
3. 多个系统的登陆校验模式不同
4. 业务系统内，强绑定了用户ID，更改用户ID会联动业务

## 目标
以最无感方式实现用户中心的构建和迁移

## 解决方案
- 初期：用户中心的建立与对接（用户无感）
  - 建立用户中心实现单点登陆方案，设计能够容纳所有系统用户数据的表及字段，设计唯一用户ID供全系统使用，做好分表分库的设计
  - 用户中心和各个系统对接，实现新的登录流程与用户信息获取方式（策略模式）
  - 各个系统用户表添加全局唯一用户ID字段，留空
  - 改造各系统登录注册页面传参，添加来自某个系统信息，其余不改动
  - 分析各个系统用户必要信息，新建新版注册页面和信息修改页面
- 登陆初测（此时用户中心无用户数据，实际是个登陆信息转发网关，使用缓存存储用户登录态）
  - 逐步改造各个系统登录页，灰度测试用户中心和各个系统间的登陆对接、登录态共享、登陆工具类的使用
  - 引导用户接受新版用户中心登录流程
  - ![](http://image.e65535.com/github/20240604194620.png)
- 首个系统数据迁移（根据业务评估将某个系统的用户数据进行迁移）
  - 评估指标
    - 以业务影响最小为准
    - 以复杂用户较少的系统优先（按照同样注册手机号和邮箱进行评估，多个系统存在同个手机号或邮箱注册的用户为复杂用户）
    - 系统使用的加密解密、密码校验是否符合用户中心要求
  - 选中系统进行二次登陆改造和同步数据改造
    - 将登陆态和登陆信息获取完全通过用户中心进行获取
    - 获取到用户信息后，判断全局唯一用户ID是否存在，如果存在进行同步入库
    - 选择系统建立全局唯一ID与局部用户ID的映射，核心业务还是通过局部用户ID进行关联
    - 系统的用户信息修改页跳转至用户中心
  - 原登陆注册页下架，上线新版用户登录注册页面和信息修改页面
  - 将该系统的用户信息全量迁移到用户中心，并通过脚本生成唯一用户ID
    - 考虑迁移的稳定性，先上架新版用户注册登陆页面，再进行数据迁移
  - 用户中心全面接收该系统的用户信息和登陆功能，其余系统仍用[登陆初测]阶段的逻辑
  - 用户中心的密码校验功能测试完成
  - ![](http://image.e65535.com/github/20240604194646.png)
- 其余系统数据迁移
  - 密码校验方式：由于其他系统的密码校验方式可能与用户中心不符，为了迁移数据，采用的方式双层校验模式
    - 用户提交登陆信息后，用户中心将账密按照自由方式校验，校验不通过去请求对应的系统
    - 如果其余系统校验通过，同步用户信息，并且将刚才的账密按照用户中心的方式进行存储
    - 存在相同用户多个账号的情况，跳转到账密过期重置页进行密码重置，并将账号标记为全平台同步完成，下次登陆不再进行其他平台的校验。同时通过接口同步多个平台信息到用户中心
    - 各系统同样进行唯一用户ID的同步与映射
  - 系统进行合并活动推送触发用户登录事件，进行一次状态更新
- 沉默用户处理
  - 运行一段时间后，通过监控统计各个系统沉默用户人数，达到阈值后进行沉默用户的锁定操作
  - 沉默用户信息合并，并标记为长时间不登录用户，需要重设密码
- 下架系统自身登录接口
- 业务基于全局唯一用户ID进行改造